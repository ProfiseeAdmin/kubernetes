---
AWSTemplateFormatVersion: '2010-09-09'
Description: 'Profisee CloudFormation template for Private subnets for VPC, EKS, RDS, and EBS setup.'

Parameters:

  VpcBlock:
    Type: String
    Default: 10.0.0.0/22
    Description: The CIDR range for the VPC. This should be a valid private (RFC 1918) CIDR range.

  PrivateEKSSubnet01Block:
    Type: String
    Default: 10.0.0.0/24
    Description: CidrBlock for EKS private subnet 01 within the VPC

  PrivateEKSSubnet02Block:
    Type: String
    Default: 10.0.1.0/24
    Description: CidrBlock for EKS private subnet 02 within the VPC

  PrivateRDSSubnet01Block:
    Type: String
    Default: 10.0.2.0/26
    Description: CidrBlock for RDS private subnet 01 within the VPC

  PrivateRDSSubnet02Block:
    Type: String
    Default: 10.0.2.64/26
    Description: CidrBlock for RDS private subnet 02 within the VPC

  PublicSubnet01Block:
    Type: String
    Default: 10.0.3.0/26
    Description: CidrBlock for public subnet 01 (NAT/ingress)

  PublicSubnet02Block:
    Type: String
    Default: 10.0.3.64/26
    Description: CidrBlock for public subnet 02 (HA NAT/ingress)

  NamePrefix:
    Type: String
    Default: Profisee
    Description: Prefix for Name tags on created resources

  EnvType:
    Type: String
    Default: dev
    Description: Environment identifier for Name tags (e.g., dev, test, prod)

  JumpboxEnabled:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Create a private EC2 jumpbox with SSM access

  JumpboxInstanceType:
    Type: String
    Default: t3.small
    Description: EC2 instance type for the jumpbox

  JumpboxAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-windows-latest/Windows_Server-2022-English-Full-Base
    Description: AMI ID for the Windows jumpbox (SSM parameter path)

  JumpboxKeyName:
    Type: String
    Default: ''
    Description: Optional EC2 key pair name (leave blank to use SSM only)

  AdditionalSecretsArn:
    Type: String
    Default: ''
    Description: Optional customer-supplied Secrets Manager ARN (or prefix ARN with *) for extra secrets (TLS certs, etc.)

  LicenseSecretArn:
    Type: String
    Default: ''
    Description: Optional pre-uploaded license Secrets Manager ARN (customer-created)

  Route53HostedZoneId:
    Type: String
    Default: ''
    Description: Optional Route53 hosted zone ID for automated DNS record updates

  EnableAlbController:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Install AWS Load Balancer Controller on the cluster

  NatMode:
    Type: String
    Default: Single
    AllowedValues:
      - Single
      - HA
      - None
    Description: NAT gateway mode (Single, HA per AZ, or None)

  ClusterName:
    Type: String
    Default: ProfiseeEKSCluster
    Description: EKS cluster name

  EKSVersion:
    Type: String
    Default: ''
    Description: EKS Kubernetes version (leave empty for AWS default)

  DBPort:
    Type: Number
    Default: 1433
    Description: Database port for node-to-db access rule

  StorageMode:
    Type: String
    Default: FSx
    AllowedValues:
      - FSx
      - EBS
    Description: FSx for shared SMB if Profisee is multi-node or EBS for single-pod storage

  DBInstanceClass:
    Type: String
    Default: db.m5.large
    Description: RDS instance class for SQL Server Standard

  DBAllocatedStorage:
    Type: Number
    Default: 50
    Description: Allocated storage (GiB) for the RDS instance

  DBMasterUsername:
    Type: String
    Default: sqladmin
    Description: RDS master username

  DBBackupRetentionDays:
    Type: Number
    Default: 7
    Description: RDS backup retention in days

  DBMultiAZ:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable Multi-AZ for RDS

  DBDeletionProtection:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable deletion protection for RDS

  FSxDirectoryId:
    Type: String
    Default: ''
    Description: AWS Directory Service ID for FSx for Windows (d-xxxxxxxxxx). Required when StorageMode=FSx

  FSxStorageCapacity:
    Type: Number
    Default: 5
    Description: FSx storage capacity (GiB)

  FSxThroughputCapacity:
    Type: Number
    Default: 16
    Description: FSx throughput capacity (MB/s)

  FSxBackupRetentionDays:
    Type: Number
    Default: 7
    Description: FSx automatic backup retention in days

  FSxEnableBackups:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable FSx automatic backups

  FSxDailyBackupStartTime:
    Type: String
    Default: ""
    Description: FSx daily backup start time (HH:MM)

  FSxEnableWeeklyMaintenanceWindow:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable FSx weekly maintenance window

  FSxWeeklyMaintenanceStartTime:
    Type: String
    Default: ""
    Description: FSx weekly maintenance time (d:HH:MM)

  EBSVolumeSize:
    Type: Number
    Default: 5
    Description: EBS volume size (GiB) for single-pod storage

  EBSVolumeType:
    Type: String
    Default: gp3
    AllowedValues:
      - gp3
      - gp2
      - io1
      - io2
    Description: EBS volume type

  EBSVolumeAZ:
    Type: String
    Default: ""
    Description: EBS volume AZ (leave empty to use PrivateEKSSubnet01 AZ)

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "Primary Worker Network Configuration"
        Parameters:
          - VpcBlock
          - PrivateEKSSubnet01Block
          - PrivateEKSSubnet02Block
          - PrivateRDSSubnet01Block
          - PrivateRDSSubnet02Block
          - PublicSubnet01Block
          - PublicSubnet02Block
          - NamePrefix
          - EnvType
          - JumpboxEnabled
          - JumpboxInstanceType
          - JumpboxAmiId
          - JumpboxKeyName
          - AdditionalSecretsArn
          - LicenseSecretArn
          - NatMode

Mappings:
  ServiceNamePrefixMap:
    aws:
      Name: com.amazonaws
    aws-cn:
      Name: cn.com.amazonaws
    aws-us-gov:
      Name: com.amazonaws

Rules:
  RequireFSxDirectoryId:
    Assertions:
      - Assert:
          Fn::Or:
            - !Equals [ !Ref StorageMode, "EBS" ]
            - !Not [ !Equals [ !Ref FSxDirectoryId, "" ] ]
        AssertDescription: "FSxDirectoryId must be provided when StorageMode=FSx."

Resources:
  ProfiseeVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:  !Ref VpcBlock
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-vpc'

  VPCDHCPOptions:
    Type: AWS::EC2::DHCPOptions
    Properties:
      DomainName: 
        Fn::Sub:
          - "ec2.internal, ${Region}.compute.internal"
          - Region: !Ref "AWS::Region"
      DomainNameServers: 
        - AmazonProvidedDNS
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-dhcp-options'

  VPCDHCPOptionsAssociation:
    Type: AWS::EC2::VPCDHCPOptionsAssociation
    Properties:
      VpcId: !Ref ProfiseeVPC
      DhcpOptionsId: !Ref VPCDHCPOptions

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: UseNat
    Properties:
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-igw'

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: UseNat
    Properties:
      VpcId: !Ref ProfiseeVPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet01:
    Type: AWS::EC2::Subnet
    Condition: UseNat
    Properties:
      VpcId: !Ref ProfiseeVPC
      CidrBlock: !Ref PublicSubnet01Block
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Fn::GetAZs:
            Ref: AWS::Region
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-public-subnet-01"
      - Key: kubernetes.io/role/elb
        Value: 1
      - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
        Value: shared

  PublicSubnet02:
    Type: AWS::EC2::Subnet
    Condition: UseNatHA
    Properties:
      VpcId: !Ref ProfiseeVPC
      CidrBlock: !Ref PublicSubnet02Block
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Fn::GetAZs:
            Ref: AWS::Region
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-public-subnet-02"
      - Key: kubernetes.io/role/elb
        Value: 1
      - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
        Value: shared
      - Key: kubernetes.io/role/elb
        Value: 1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Condition: UseNat
    Properties:
      VpcId: !Ref ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-public-rt'

  PublicRoute:
    Type: AWS::EC2::Route
    Condition: UseNat
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
    DependsOn: VPCGatewayAttachment

  PublicSubnet01RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseNat
    Properties:
      SubnetId: !Ref PublicSubnet01
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet02RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseNatHA
    Properties:
      SubnetId: !Ref PublicSubnet02
      RouteTableId: !Ref PublicRouteTable

  NatEip01:
    Type: AWS::EC2::EIP
    Condition: UseNat
    Properties:
      Domain: vpc

  NatGateway01:
    Type: AWS::EC2::NatGateway
    Condition: UseNat
    Properties:
      AllocationId: !GetAtt NatEip01.AllocationId
      SubnetId: !Ref PublicSubnet01

  NatEip02:
    Type: AWS::EC2::EIP
    Condition: UseNatHA
    Properties:
      Domain: vpc

  NatGateway02:
    Type: AWS::EC2::NatGateway
    Condition: UseNatHA
    Properties:
      AllocationId: !GetAtt NatEip02.AllocationId
      SubnetId: !Ref PublicSubnet02

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-private-rt'

  PrivateDefaultRoute:
    Type: AWS::EC2::Route
    Condition: UseNat
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway01

  PrivateRouteTable02:
    Type: AWS::EC2::RouteTable
    Condition: UseNatHA
    Properties:
      VpcId: !Ref ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-private-rt-az2'

  PrivateDefaultRoute02:
    Type: AWS::EC2::Route
    Condition: UseNatHA
    Properties:
      RouteTableId: !Ref PrivateRouteTable02
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway02

  PrivateEKSSubnet01:
    Type: AWS::EC2::Subnet
    Metadata:
      Comment: Private EKS Subnet 01
    Properties:
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Fn::GetAZs:
            Ref: AWS::Region
      CidrBlock:
        Ref: PrivateEKSSubnet01Block
      VpcId:
        Ref: ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-eks-subnet-01"
      - Key: kubernetes.io/role/internal-elb
        Value: 1
      - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
        Value: shared

  PrivateEKSSubnet02:
    Type: AWS::EC2::Subnet
    Metadata:
      Comment: Private EKS Subnet 02
    Properties:
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Fn::GetAZs:
            Ref: AWS::Region
      CidrBlock:
        Ref: PrivateEKSSubnet02Block
      VpcId:
        Ref: ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-eks-subnet-02"
      - Key: kubernetes.io/role/internal-elb
        Value: 1
      - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
        Value: shared

  PrivateRDSSubnet01:
    Type: AWS::EC2::Subnet
    Metadata:
      Comment: Private RDS Subnet 01
    Properties:
      AvailabilityZone:
        Fn::Select:
        - '0'
        - Fn::GetAZs:
            Ref: AWS::Region
      CidrBlock:
        Ref: PrivateRDSSubnet01Block
      VpcId:
        Ref: ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-rds-subnet-01"

  PrivateRDSSubnet02:
    Type: AWS::EC2::Subnet
    Metadata:
      Comment: Private RDS Subnet 02
    Properties:
      AvailabilityZone:
        Fn::Select:
        - '1'
        - Fn::GetAZs:
            Ref: AWS::Region
      CidrBlock:
        Ref: PrivateRDSSubnet02Block
      VpcId:
        Ref: ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub "${NamePrefix}-${EnvType}-rds-subnet-02"

  PrivateEKSSubnet01RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateEKSSubnet01
      RouteTableId: !Ref PrivateRouteTable

  PrivateEKSSubnet02RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateEKSSubnet02
      RouteTableId: !If [UseNatHA, !Ref PrivateRouteTable02, !Ref PrivateRouteTable]

  PrivateRDSSubnet01RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateRDSSubnet01
      RouteTableId: !Ref PrivateRouteTable

  PrivateRDSSubnet02RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateRDSSubnet02
      RouteTableId: !If [UseNatHA, !Ref PrivateRouteTable02, !Ref PrivateRouteTable]

  #Endpoint Security Group, access only via HTTPS
  EndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group to govern who can access the endpoints
      VpcId: !Ref ProfiseeVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref VpcBlock
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-endpoint-sg'

  #Services' endpoints
  S3APIEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-s3-endpoint'
      VpcId: !Ref ProfiseeVPC

  ECRAPIEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "ecr.api" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ecr-api-endpoint'
      VpcId: !Ref ProfiseeVPC

  EKSEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "eks" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-eks-endpoint'
      VpcId: !Ref ProfiseeVPC

  ELBEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "elasticloadbalancing" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-elb-endpoint'
      VpcId: !Ref ProfiseeVPC

  ECRDockerEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "ecr.dkr" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ecr-dkr-endpoint'
      VpcId: !Ref ProfiseeVPC

  EC2Endpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "ec2" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ec2-endpoint'
      VpcId: !Ref ProfiseeVPC

  CWLogsEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.logs"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-logs-endpoint'
      VpcId: !Ref ProfiseeVPC

  STSEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName:
        !Join [ ".", [ !FindInMap [ServiceNamePrefixMap, !Ref "AWS::Partition", Name], !Ref "AWS::Region", "sts" ] ]
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-sts-endpoint'
      VpcId: !Ref ProfiseeVPC

  ControlPlaneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Cluster communication with worker nodes
      VpcId: !Ref ProfiseeVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref NodeSecurityGroup
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-controlplane-sg'

  NodeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: EKS worker node SG
      VpcId: !Ref ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-node-sg'

  JumpboxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: UseJumpbox
    Properties:
      GroupDescription: Jumpbox SG (no inbound, SSM only)
      VpcId: !Ref ProfiseeVPC
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-jumpbox-sg'

  JumpboxToControlPlaneIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: UseJumpbox
    Properties:
      GroupId: !Ref ControlPlaneSecurityGroup
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443
      SourceSecurityGroupId: !Ref JumpboxSecurityGroup

  NodeToControlPlaneIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref NodeSecurityGroup
      IpProtocol: tcp
      FromPort: 1025
      ToPort: 65535
      SourceSecurityGroupId: !Ref ControlPlaneSecurityGroup

  NodeToNodeAllTraffic:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref NodeSecurityGroup
      IpProtocol: -1
      FromPort: 0
      ToPort: 65535
      SourceSecurityGroupId: !Ref NodeSecurityGroup

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS SQL Server security group
      VpcId: !Ref ProfiseeVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref DBPort
          ToPort: !Ref DBPort
          SourceSecurityGroupId: !Ref NodeSecurityGroup
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-rds-sg'

  NodeToDBIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref DBSecurityGroup
      IpProtocol: tcp
      FromPort: !Ref DBPort
      ToPort: !Ref DBPort
      SourceSecurityGroupId: !Ref NodeSecurityGroup

  #Cluster and Node roles
  #EKS Cluster Role
  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      Path: '/'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
        - arn:aws:iam::aws:policy/AmazonEKSServicePolicy
  # EKS Cluster
  ProfiseeEKSCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Name: !Ref ClusterName
      Version: !If [HasEKSVersion, !Ref EKSVersion, !Ref AWS::NoValue]
      RoleArn: !GetAtt EKSClusterRole.Arn
      AccessConfig:
        AuthenticationMode: API_AND_CONFIG_MAP
      ResourcesVpcConfig:
        SecurityGroupIds: [!Ref ControlPlaneSecurityGroup ]
        SubnetIds: [ !Ref PrivateEKSSubnet01, !Ref PrivateEKSSubnet02 ]
        EndpointPrivateAccess: true
        EndpointPublicAccess: false

  AlbControllerOidcProvider:
    Type: AWS::IAM::OIDCProvider
    Condition: UseAlbController
    Properties:
      Url: !GetAtt ProfiseeEKSCluster.OidcIssuerUrl
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 9e99a48a9960b14926bb7f3b02e22da0afd40a7c

  AlbControllerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Condition: UseAlbController
    Properties:
      ManagedPolicyName: !Sub '${NamePrefix}-${EnvType}-AWSLoadBalancerControllerPolicy'
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
            Resource: "*"
            Condition:
              StringEquals:
                iam:AWSServiceName: elasticloadbalancing.amazonaws.com
          - Effect: Allow
            Action:
              - ec2:DescribeAccountAttributes
              - ec2:DescribeAddresses
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInternetGateways
              - ec2:DescribeVpcs
              - ec2:DescribeVpcPeeringConnections
              - ec2:DescribeSubnets
              - ec2:DescribeSecurityGroups
              - ec2:DescribeInstances
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeTags
              - ec2:GetCoipPoolUsage
              - ec2:DescribeCoipPools
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeLoadBalancerAttributes
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeListenerCertificates
              - elasticloadbalancing:DescribeSSLPolicies
              - elasticloadbalancing:DescribeRules
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetGroupAttributes
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:DescribeTags
            Resource: "*"
          - Effect: Allow
            Action:
              - cognito-idp:DescribeUserPoolClient
              - acm:ListCertificates
              - acm:DescribeCertificate
              - iam:ListServerCertificates
              - iam:GetServerCertificate
              - waf-regional:GetWebACL
              - waf-regional:GetWebACLForResource
              - waf-regional:AssociateWebACL
              - waf-regional:DisassociateWebACL
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:AssociateWebACL
              - wafv2:DisassociateWebACL
              - shield:GetSubscriptionState
              - shield:DescribeProtection
              - shield:CreateProtection
              - shield:DeleteProtection
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:CreateSecurityGroup
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource: !Sub 'arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*'
            Condition:
              StringEquals:
                ec2:CreateAction: CreateSecurityGroup
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource: !Sub 'arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*'
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "true"
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
              - ec2:DeleteSecurityGroup
            Resource: "*"
            Condition:
              "Null":
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
            Resource: "*"
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:CreateRule
              - elasticloadbalancing:DeleteRule
            Resource: "*"
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/*/*'
              - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/net/*/*'
              - !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:loadbalancer/app/*/*'
            Condition:
              "Null":
                aws:RequestTag/elbv2.k8s.aws/cluster: "false"
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:ModifyLoadBalancerAttributes
              - elasticloadbalancing:SetIpAddressType
              - elasticloadbalancing:SetSecurityGroups
              - elasticloadbalancing:SetSubnets
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:ModifyTargetGroup
              - elasticloadbalancing:ModifyTargetGroupAttributes
              - elasticloadbalancing:DeleteTargetGroup
            Resource: "*"
            Condition:
              "Null":
                aws:ResourceTag/elbv2.k8s.aws/cluster: "false"
          - Effect: Allow
            Action:
              - elasticloadbalancing:RegisterTargets
              - elasticloadbalancing:DeregisterTargets
            Resource: !Sub 'arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/*/*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:SetWebAcl
              - elasticloadbalancing:ModifyListener
              - elasticloadbalancing:AddListenerCertificates
              - elasticloadbalancing:RemoveListenerCertificates
              - elasticloadbalancing:ModifyRule
            Resource: "*"
          - Effect: Allow
            Action:
              - ec2:DescribeInstances
              - ec2:DescribeInstanceStatus
              - ec2:DescribeTags
            Resource: "*"

  AlbControllerRole:
    Type: AWS::IAM::Role
    Condition: UseAlbController
    Properties:
      RoleName: !Sub '${NamePrefix}-${EnvType}-AlbControllerRole'
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref AlbControllerOidcProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                ? !Sub
                  - "${OidcProvider}:aud"
                  - OidcProvider: !Select [1, !Split ["https://", !GetAtt ProfiseeEKSCluster.OidcIssuerUrl]]
                : "sts.amazonaws.com"
                ? !Sub
                  - "${OidcProvider}:sub"
                  - OidcProvider: !Select [1, !Split ["https://", !GetAtt ProfiseeEKSCluster.OidcIssuerUrl]]
                : "system:serviceaccount:kube-system:aws-load-balancer-controller"
      ManagedPolicyArns:
        - !Ref AlbControllerPolicy
  
  #Node role
  EKSNodeRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "ec2.amazonaws.com"
            Action: "sts:AssumeRole"
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"
        - "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
        - "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"

  JumpboxRole:
    Type: AWS::IAM::Role
    Condition: UseJumpbox
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: "/"
      Policies:
        - PolicyName: JumpboxEksDescribe
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - eks:DescribeCluster
                Resource: !Sub 'arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ClusterName}'
        - PolicyName: JumpboxEksAccessEntry
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - eks:CreateAccessEntry
                  - eks:AssociateAccessPolicy
                  - eks:DescribeAccessEntry
                  - eks:ListAccessEntries
                  - eks:ListAssociatedAccessPolicies
                Resource:
                  - !Sub 'arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ClusterName}'
                  - !Sub 'arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${ClusterName}/*'
        - PolicyName: JumpboxCfnRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackResources
                  - cloudformation:ListStackResources
                Resource: !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*'
        - PolicyName: JumpboxSecretsRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref RDSMasterSecret
              - !If
                - HasAdditionalSecretsArn
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                  Resource: !Ref AdditionalSecretsArn
                - !Ref AWS::NoValue
              - !If
                - HasLicenseSecretArn
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                  Resource: !Ref LicenseSecretArn
                - !Ref AWS::NoValue
        - !If
          - HasRoute53HostedZoneId
          - PolicyName: JumpboxRoute53
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - route53:ChangeResourceRecordSets
                  Resource: !Sub 'arn:aws:route53:::hostedzone/${Route53HostedZoneId}'
                - Effect: Allow
                  Action:
                    - route53:GetHostedZone
                    - route53:ListHostedZones
                    - route53:ListHostedZonesByName
                    - route53:ListResourceRecordSets
                  Resource: "*"
          - !Ref AWS::NoValue

  JumpboxInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: UseJumpbox
    Properties:
      Path: "/"
      Roles:
        - !Ref JumpboxRole

  #Linux Node Groups
  LinuxNG:
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName: !Ref ProfiseeEKSCluster
      NodegroupName: LinuxNG
      ScalingConfig:
        MinSize: 2
        MaxSize: 3
        DesiredSize: 2
      InstanceTypes:
        - t2.medium
      Subnets: 
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      AmiType: AL2023_x86_64_STANDARD
      NodeRole: !GetAtt EKSNodeRole.Arn
      LaunchTemplate:
        Id: !Ref LinuxLaunchTemplate
        Version: !GetAtt LinuxLaunchTemplate.LatestVersionNumber
      Tags:
        Name: !Sub '${NamePrefix}-${EnvType}-linux-ng'
  
  # Windows Node Group 
  WinNG:
    Type: AWS::EKS::Nodegroup
    Properties:
      ClusterName: !Ref ProfiseeEKSCluster
      NodegroupName: WinNG
      ScalingConfig:
        MinSize: 1
        MaxSize: 1
        DesiredSize: 1
      InstanceTypes:
        - m5.xlarge
      Subnets: 
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      AmiType:  WINDOWS_CORE_2022_x86_64
      NodeRole: !GetAtt EKSNodeRole.Arn
      LaunchTemplate:
        Id: !Ref WindowsLaunchTemplate
        Version: !GetAtt WindowsLaunchTemplate.LatestVersionNumber
      Tags:
        Name: !Sub '${NamePrefix}-${EnvType}-windows-ng'

  LinuxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        SecurityGroupIds:
          - !Ref NodeSecurityGroup

  WindowsLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        SecurityGroupIds:
          - !Ref NodeSecurityGroup

  JumpboxInstance:
    Type: AWS::EC2::Instance
    Condition: UseJumpbox
    Properties:
      ImageId: !Ref JumpboxAmiId
      InstanceType: !Ref JumpboxInstanceType
      IamInstanceProfile: !Ref JumpboxInstanceProfile
      SubnetId: !Ref PrivateEKSSubnet01
      SecurityGroupIds:
        - !Ref JumpboxSecurityGroup
      KeyName: !If
        - HasJumpboxKey
        - !Ref JumpboxKeyName
        - !Ref AWS::NoValue
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
            <powershell>
            $ProgressPreference = 'SilentlyContinue'
            # Give IAM/SSM/EKS time to settle and permissions to propagate
            Start-Sleep -Seconds 300

            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            $env:ChocolateyUsePowerShellHttpClient = 'true'
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
            choco upgrade chocolatey awscli kubernetes-cli kubernetes-helm eksctl -y --no-progress
            Import-Module C:\ProgramData\chocolatey\helpers\chocolateyProfile.psm1
            refreshenv

            $natMode = "${NatMode}"
            if ($natMode -ne "None") {
              $clusterName = "${ClusterName}"
              $region = "${AWS::Region}"

              $deadline = (Get-Date).AddMinutes(20)
              do {
                $status = aws eks describe-cluster --name $clusterName --region $region --query "cluster.status" --output text 2>$null
                if ($status -eq "ACTIVE") { break }
                Start-Sleep -Seconds 30
              } while ((Get-Date) -lt $deadline)

              $callerArn = aws sts get-caller-identity --query "Arn" --output text
              if ($callerArn -match "arn:aws:sts::([0-9]+):assumed-role/([^/]+)/") {
                $accountId = $matches[1]
                $roleName = $matches[2]
                $roleArn = "arn:aws:iam::$accountId:role/$roleName"

                $existing = aws eks list-access-entries --cluster-name $clusterName --region $region --query "accessEntries[?principalArn=='$roleArn'] | length(@)" --output text
                if ($existing -eq "0") {
                  aws eks create-access-entry --cluster-name $clusterName --region $region --principal-arn $roleArn
                }

                aws eks associate-access-policy --cluster-name $clusterName --region $region --principal-arn $roleArn --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy --access-scope type=cluster
              }
            }

            if ("${EnableAlbController}" -eq "true") {
              $clusterName = "${ClusterName}"
              $region = "${AWS::Region}"
              $albRoleArn = "${AlbControllerRoleArn}"

              aws eks update-kubeconfig --name $clusterName --region $region | Out-Null

              $vpcId = aws eks describe-cluster --name $clusterName --region $region --query "cluster.resourcesVpcConfig.vpcId" --output text
              $existing = kubectl get deployment -n kube-system aws-load-balancer-controller --ignore-not-found
              if ([string]::IsNullOrWhiteSpace($existing)) {
                $sa = @"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aws-load-balancer-controller
  namespace: kube-system
  annotations:
    eks.amazonaws.com/role-arn: $albRoleArn
"@
                $sa | kubectl apply -f -

                helm repo add eks https://aws.github.io/eks-charts
                helm repo update
                helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller `
                  -n kube-system `
                  --set clusterName=$clusterName `
                  --set serviceAccount.create=false `
                  --set serviceAccount.name=aws-load-balancer-controller `
                  --set region=$region `
                  --set vpcId=$vpcId
              }
            }
            </powershell>
            - AlbControllerRoleArn: !If [UseAlbController, !GetAtt AlbControllerRole.Arn, ""]
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-jumpbox'

  SSMEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ssm-endpoint'
      VpcId: !Ref ProfiseeVPC

  SSMMessagesEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssmmessages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ssmmessages-endpoint'
      VpcId: !Ref ProfiseeVPC

  EC2MessagesEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.ec2messages"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ec2messages-endpoint'
      VpcId: !Ref ProfiseeVPC

  AutoScalingEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.autoscaling"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-autoscaling-endpoint'
      VpcId: !Ref ProfiseeVPC

  KMSEndpoint:
    Type: "AWS::EC2::VPCEndpoint"
    Properties:
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.kms"
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !GetAtt EndpointSecurityGroup.GroupId
      SubnetIds:
        - !Ref PrivateEKSSubnet01
        - !Ref PrivateEKSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-kms-endpoint'
      VpcId: !Ref ProfiseeVPC

  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Profisee RDS subnet group
      SubnetIds:
        - !Ref PrivateRDSSubnet01
        - !Ref PrivateRDSSubnet02
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-rds-subnet-group'

  RDSMasterSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AWS::StackName}-rds-master"
      Description: RDS SQL Server master credentials
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username":"${DBMasterUsername}"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: "/'\"@"
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-rds-master-secret'

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      Engine: sqlserver-se
      LicenseModel: license-included
      DBInstanceClass: !Ref DBInstanceClass
      AllocatedStorage: !Ref DBAllocatedStorage
      StorageType: gp3
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Sub "{{resolve:secretsmanager:${RDSMasterSecret}:SecretString:password}}"
      DBSubnetGroupName: !Ref RDSSubnetGroup
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      PubliclyAccessible: false
      MultiAZ: !Ref DBMultiAZ
      BackupRetentionPeriod: !Ref DBBackupRetentionDays
      DeletionProtection: !Ref DBDeletionProtection
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-rds'

  FSxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: UseFSx
    Properties:
      GroupDescription: FSx SMB access from EKS nodes
      VpcId: !Ref ProfiseeVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 445
          ToPort: 445
          SourceSecurityGroupId: !Ref NodeSecurityGroup
      Tags:
      - Key: Name
        Value: !Sub '${NamePrefix}-${EnvType}-fsx-sg'

  FSxFileSystem:
    Type: AWS::FSx::FileSystem
    Condition: UseFSx
    Properties:
      FileSystemType: WINDOWS
      StorageCapacity: !Ref FSxStorageCapacity
      SubnetIds:
        - !Ref PrivateEKSSubnet01
      SecurityGroupIds:
        - !Ref FSxSecurityGroup
      WindowsConfiguration:
        ActiveDirectoryId: !Ref FSxDirectoryId
        DeploymentType: SINGLE_AZ_1
        ThroughputCapacity: !Ref FSxThroughputCapacity
        AutomaticBackupRetentionDays: !If
          - FSxBackupsEnabled
          - !Ref FSxBackupRetentionDays
          - !Ref AWS::NoValue
        DailyAutomaticBackupStartTime: !If
          - FSxBackupStartTimeProvided
          - !Ref FSxDailyBackupStartTime
          - !Ref AWS::NoValue
        WeeklyMaintenanceStartTime: !If
          - FSxMaintenanceEnabled
          - !Ref FSxWeeklyMaintenanceStartTime
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-fsx'

  EBSVolume:
    Type: AWS::EC2::Volume
    Condition: UseEBS
    Properties:
      Size: !Ref EBSVolumeSize
      VolumeType: !Ref EBSVolumeType
      AvailabilityZone: !If
        - HasEBSVolumeAZ
        - !Ref EBSVolumeAZ
        - !GetAtt PrivateEKSSubnet01.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Sub '${NamePrefix}-${EnvType}-ebs'

Conditions:
  UseFSx: !Equals [ !Ref StorageMode, "FSx" ]
  UseEBS: !Equals [ !Ref StorageMode, "EBS" ]
  HasEBSVolumeAZ: !Not [ !Equals [ !Ref EBSVolumeAZ, "" ] ]
  FSxBackupsEnabled: !Equals [ !Ref FSxEnableBackups, "true" ]
  FSxBackupStartTimeProvided: !And
    - !Condition FSxBackupsEnabled
    - !Not [ !Equals [ !Ref FSxDailyBackupStartTime, "" ] ]
  FSxMaintenanceEnabled: !And
    - !Condition UseFSx
    - !Equals [ !Ref FSxEnableWeeklyMaintenanceWindow, "true" ]
  UseJumpbox: !Equals [ !Ref JumpboxEnabled, "true" ]
  HasJumpboxKey: !Not [ !Equals [ !Ref JumpboxKeyName, "" ] ]
  UseNat: !Or [ !Equals [ !Ref NatMode, "Single" ], !Equals [ !Ref NatMode, "HA" ] ]
  UseNatHA: !Equals [ !Ref NatMode, "HA" ]
  HasAdditionalSecretsArn: !Not [ !Equals [ !Ref AdditionalSecretsArn, "" ] ]
  HasLicenseSecretArn: !Not [ !Equals [ !Ref LicenseSecretArn, "" ] ]
  HasRoute53HostedZoneId: !Not [ !Equals [ !Ref Route53HostedZoneId, "" ] ]
  HasEKSVersion: !Not [ !Equals [ !Ref EKSVersion, "" ] ]
  UseAlbController: !Equals [ !Ref EnableAlbController, "true" ]

Outputs:

  ClusterName:
    Description: EKS cluster name
    Value: !Ref ClusterName

  ClusterArn:
    Description: EKS cluster ARN
    Value: !GetAtt ProfiseeEKSCluster.Arn

  ClusterRegion:
    Description: AWS region for the cluster
    Value: !Ref AWS::Region

  VpcId:
    Description: The VPC ID
    Value: !Ref ProfiseeVPC

  SubnetIds:
    Description: All subnets in the VPC
    Value: !Join [ ",", [ !Ref PrivateEKSSubnet01, !Ref PrivateEKSSubnet02, !Ref PrivateRDSSubnet01, !Ref PrivateRDSSubnet02 ] ]

  PublicSubnet01Id:
    Description: Public subnet 01 ID
    Condition: UseNat
    Value: !Ref PublicSubnet01

  PublicSubnet02Id:
    Description: Public subnet 02 ID (HA only)
    Condition: UseNatHA
    Value: !Ref PublicSubnet02

  NatGateway01Id:
    Description: NAT Gateway 01 ID
    Condition: UseNat
    Value: !Ref NatGateway01

  NatGateway02Id:
    Description: NAT Gateway 02 ID (HA only)
    Condition: UseNatHA
    Value: !Ref NatGateway02

  SecurityGroups:
    Description: Security group for the cluster control plane communication with worker nodes
    Value: !Join [ ",", [ !Ref ControlPlaneSecurityGroup ] ]

  RDSInstanceEndpoint:
    Description: RDS SQL Server endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address

  RDSMasterSecretArn:
    Description: ARN of the RDS master secret
    Value: !Ref RDSMasterSecret

  FSxDnsName:
    Description: FSx DNS name
    Condition: UseFSx
    Value: !GetAtt FSxFileSystem.DNSName

  FSxSharePath:
    Description: FSx default share path
    Condition: UseFSx
    Value: !Sub "\\\\${FSxFileSystem.DNSName}\\share"

  EBSVolumeId:
    Description: EBS volume ID (single-pod storage)
    Condition: UseEBS
    Value: !Ref EBSVolume

  JumpboxInstanceId:
    Description: Jumpbox instance ID (SSM only)
    Condition: UseJumpbox
    Value: !Ref JumpboxInstance

  JumpboxRoleArn:
    Description: Jumpbox IAM role ARN
    Condition: UseJumpbox
    Value: !GetAtt JumpboxRole.Arn
